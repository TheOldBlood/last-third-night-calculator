<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.webmanifest" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>Last Third of Night Calculator</title>
</head>

<body>


    <script type="module">
        function getPartNight(fajrhour, fajrmin, magribhour, magribmin) {
            let magribDate = new Date()
            let fajrDate = new Date(magribDate)
            magribDate.setHours(magribhour)
            magribDate.setMinutes(magribmin)
            fajrDate.setHours(fajrhour)
            fajrDate.setMinutes(fajrmin)

            let diff;
            // Calculate the time from fajr to magrib and subtract it with 1 day in millis to get the time between magrib and fajr
            if (magribDate > fajrDate)
                diff = 86400000 - (magribDate - fajrDate)
            // Calculate the time from magrib to fajr as fajrDate is bigger than magribDate
            else
                diff = fajrDate - magribDate
            let twothirdNight = new Date(magribDate.getTime() + (diff * 2 / 3))
            let halfNight = new Date(magribDate.getTime() + (diff * 1 / 2))
            return [halfNight, twothirdNight]

        }

        window.setPartNight = function () {
            if (document.querySelector('#fajrtime').value != '' && document.querySelector('#magribtime').value != '') {
                let [halfNight, twothirdNight] = getPartNight(...document.querySelector('#fajrtime').value.split(':'), ...document.querySelector('#magribtime').value.split(':'))
                document.querySelector('#placeholder').innerText = "Mid Night Begins At: " + halfNight.toLocaleString('default', { hour: 'numeric', minute: 'numeric' }) +
                    "\nLast Third Night Begins At: " + twothirdNight.toLocaleString('default', { hour: 'numeric', minute: 'numeric' })
            }
        }

        window.autoDetectWithCoords = function () {
            if ('geolocation' in navigator)
                navigator.geolocation.getCurrentPosition(pos => {

                    var solar = new SolarCalc(new Date(), pos.coords.latitude, pos.coords.longitude);
                    let fajrDate = solar.astronomicalDawn;
                    let magribDate = solar.sunset;

                    document.querySelector('#fajrtime').value = fajrDate.toLocaleString('default', { hour: 'numeric', minute: 'numeric', hour12: false })
                    document.querySelector('#magribtime').value = magribDate.toLocaleString('default', { hour: 'numeric', minute: 'numeric', hour12: false })


                    setPartNight()


                })




        }

        // Register Service worker for Add to Home Screen option to work
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register(new URL('service-worker.js', import.meta.url)) }

        function ready() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })



        }

        document.addEventListener("DOMContentLoaded", ready);

        import * as SolarCalc from 'solar-calc'

    </script>
    <div class="container m-2">
        <h1>Last Third of Night Calculator</h1>
        <div class="input-group">

            <label for="fajrtime" class="m-2">Enter Fajr Time: </label>
            <input id="fajrtime" class="m-2" type="time" name="fajrtime" oninput="setPartNight()"><br>
            <label for="magribtime" class="m-2">Enter Magrib Time: </label>
            <input id="magribtime" class="m-2" type="time" name="magribtime" oninput="setPartNight()">
            <button type="button" class="btn btn-secondary m-1" data-bs-toggle="tooltip"
                title="Results may be inaccurate" onclick="autoDetectWithCoords()">Auto Detect</button>
        </div>

        <div id='placeholder' class="border fs-5 text text-center">
            Mid Night: Result will show here <br>
            Last Third Night: Result will show here
        </div>
        <br>
        <br>
        <br>
        <p class="fst-italic fs-5">

            Abu Huraira reported: The Messenger of Allah, peace and blessings be upon him, said, “Our Lord Almighty
            descends to the lowest heaven in the last third of every night, saying: Who is calling upon Me that I may
            answer him? Who is asking from Me that I may give him? Who is seeking My forgiveness that I may forgive
            him?”
            [Source: Ṣaḥīḥ al-Bukhārī 1145, Ṣaḥīḥ Muslim 758]
        </p>
    </div>
    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    -->
</body>

</html>